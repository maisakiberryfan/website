<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songlist JSON 轉換工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1000px; }
        .json-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-download {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-download:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">🎵 Songlist JSON 轉換工具</h1>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">📋 使用說明</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>原始格式:</strong></p>
                        <code>[{"songID": "1", "songName": "adrenaline!!!", "artist": "TrySail", "genre": "アニソン", ...}, ...]</code>
                        <p class="mt-2"><strong>轉換後格式:</strong></p>
                        <code>{"adrenaline!!!": "TrySail", ...}</code>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">📝 輸入原始 JSON</h5>
                            </div>
                            <div class="card-body">
                                <textarea
                                    id="inputJson"
                                    class="form-control"
                                    rows="15"
                                    placeholder="請貼入原始 JSON 陣列...&#10;例如:&#10;[&#10;  {&#10;    &quot;songID&quot;: &quot;1&quot;,&#10;    &quot;songName&quot;: &quot;adrenaline!!!&quot;,&#10;    &quot;artist&quot;: &quot;TrySail&quot;,&#10;    &quot;genre&quot;: &quot;アニソン&quot;&#10;  }&#10;]"
                                ></textarea>
                                <div class="mt-3">
                                    <button id="convertBtn" class="btn btn-primary">🔄 轉換格式</button>
                                    <button id="clearBtn" class="btn btn-outline-secondary ms-2">🗑️ 清空</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">📊 轉換結果</h5>
                                <span id="songCount" class="badge bg-info">0 首歌曲</span>
                            </div>
                            <div class="card-body">
                                <pre id="outputJson" class="json-display p-3 mb-3">轉換結果將顯示在這裡...</pre>
                                <div>
                                    <button id="downloadBtn" class="btn btn-download" disabled>
                                        📥 下載 songlist.json
                                    </button>
                                    <button id="copyBtn" class="btn btn-outline-primary ms-2" disabled>
                                        📋 複製到剪貼板
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <h6><strong>📌 注意事項:</strong></h6>
                    <ul class="mb-0">
                        <li>只會提取 <code>songName</code> 和 <code>artist</code> 欄位</li>
                        <li>缺少任一欄位的項目會被跳過</li>
                        <li>轉換後保持原始順序，不會排序</li>
                        <li>下載檔案後請手動替換 <code>worker/src/songlist.json</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SonglistConverter {
            constructor() {
                this.initElements();
                this.bindEvents();
            }

            initElements() {
                this.inputJson = document.getElementById('inputJson');
                this.outputJson = document.getElementById('outputJson');
                this.convertBtn = document.getElementById('convertBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.copyBtn = document.getElementById('copyBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.songCount = document.getElementById('songCount');
            }

            bindEvents() {
                this.convertBtn.addEventListener('click', () => this.convertJson());
                this.downloadBtn.addEventListener('click', () => this.downloadFile());
                this.copyBtn.addEventListener('click', () => this.copyToClipboard());
                this.clearBtn.addEventListener('click', () => this.clearInput());
            }

            convertJson() {
                const input = this.inputJson.value.trim();

                if (!input) {
                    this.showError('請輸入 JSON 資料');
                    return;
                }

                try {
                    const inputData = JSON.parse(input);

                    if (!Array.isArray(inputData)) {
                        this.showError('輸入必須是 JSON 陣列格式');
                        return;
                    }

                    const converted = this.performConversion(inputData);
                    this.displayResult(converted);

                } catch (error) {
                    this.showError('JSON 格式錯誤: ' + error.message);
                }
            }

            performConversion(inputArray) {
                const result = {};
                let processedCount = 0;
                let skippedCount = 0;

                inputArray.forEach((song, index) => {
                    if (song.songName && song.artist) {
                        result[song.songName] = song.artist;
                        processedCount++;
                    } else {
                        console.warn(`跳過第 ${index + 1} 項：缺少 songName 或 artist`);
                        skippedCount++;
                    }
                });

                console.log(`轉換完成: ${processedCount} 首成功，${skippedCount} 首跳過`);
                return result;
            }

            displayResult(convertedData) {
                const jsonString = JSON.stringify(convertedData, null, 2);
                this.outputJson.textContent = jsonString;

                const songCount = Object.keys(convertedData).length;
                this.songCount.textContent = `${songCount} 首歌曲`;

                this.downloadBtn.disabled = false;
                this.copyBtn.disabled = false;

                // 儲存結果供下載使用
                this.convertedData = jsonString;
            }

            downloadFile() {
                if (!this.convertedData) {
                    this.showError('沒有可下載的資料');
                    return;
                }

                const blob = new Blob([this.convertedData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'songlist.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                URL.revokeObjectURL(url);

                this.showSuccess('檔案已下載！請手動替換 worker/src/songlist.json');
            }

            async copyToClipboard() {
                if (!this.convertedData) {
                    this.showError('沒有可複製的資料');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(this.convertedData);
                    this.showSuccess('已複製到剪貼板！');
                } catch (err) {
                    // 備用方案
                    const textArea = document.createElement('textarea');
                    textArea.value = this.convertedData;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);

                    this.showSuccess('已複製到剪貼板！');
                }
            }

            clearInput() {
                this.inputJson.value = '';
                this.outputJson.textContent = '轉換結果將顯示在這裡...';
                this.songCount.textContent = '0 首歌曲';
                this.downloadBtn.disabled = true;
                this.copyBtn.disabled = true;
                this.convertedData = null;
            }

            showError(message) {
                this.showAlert(message, 'danger');
            }

            showSuccess(message) {
                this.showAlert(message, 'success');
            }

            showAlert(message, type) {
                // 移除現有的 alert
                const existingAlert = document.querySelector('.alert-dismissible');
                if (existingAlert) {
                    existingAlert.remove();
                }

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const container = document.querySelector('.container');
                container.insertBefore(alertDiv, container.firstChild);

                // 3 秒後自動移除
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        }

        // 初始化轉換器
        document.addEventListener('DOMContentLoaded', () => {
            new SonglistConverter();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>